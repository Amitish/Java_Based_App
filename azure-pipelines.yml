
trigger: none

pool: mera-pool

stages:
- stage: 
  jobs:
  - job: 
    steps:
    # - task: Maven@4
    #   inputs:
    #     azureSubscription: 'gusi-sc'
    #     mavenPomFile: 'pom.xml'
    #     goals: 'mvn clean package'
    #     publishJUnitResults: true
    #     testResultsFiles: '**/surefire-reports/TEST-*.xml'
    #     javaHomeOption: 'JDKVersion'
    #     mavenVersionOption: 'Default'
    #     mavenAuthenticateFeed: false
    #     effectivePomSkip: false
    #     sonarQubeRunAnalysis: false

    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Pre-check if MAVEN is already installed . . .
          mvn --version
          mvn clean package

    - task: PublishPipelineArtifact@1
      displayName: Publish Artifacts
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/target'
        artifact: 'my-java'
        publishLocation: 'pipeline'


- stage: 
  jobs:
  - job: 
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'my-java'
        targetPath: '$(System.DefaultWorkingDirectory)/target'


    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'my-java-vm'
        sourceFolder: '$(System.DefaultWorkingDirectory)/target'
        contents: '*.war'
        targetFolder: '/home/ambition'
        readyTimeout: '20000'

    - task: SSH@0
      inputs:
        sshEndpoint: 'my-java-vm'
        runOptions: 'inline'
        inline: 'sudo cp -r /home/ambition/* /var/lib/tomcat9/webapps/'
        readyTimeout: '20000'